#!/usr/bin/env python3
# usage: plash cleantmp
# cleanup plash's tmp directory

import os
import sys
from plash import utils
import shutil

utils.handle_help_flag()

tmp = os.path.join(utils.get_plash_data(), 'tmp')
for file in os.listdir(tmp):
    abs_file = os.path.join(tmp, file)

    try:
        _, sid, pid, *_ = file.split('_')
        pid = int(pid)
    except ValueError:
        print('bad {}'.format(abs_file), file=sys.stderr)
        continue

    try:
        real_sid = os.getsid(pid)
    except ProcessLookupError:
        # no such pid, delete its tmp data
        delete = True
    else:
        if str(sid) == str(real_sid):
            # process still alive, don't delete its tmp dir
            delete = False
        else:
            # sid mismatch, its another one, delete
            delete = True

    if delete:
        print('deleting {}'.format(abs_file), file=sys.stderr)
        shutil.rmtree(abs_file)
