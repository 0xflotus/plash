#!/usr/bin/python3
import argparse
import atexit
import os
import subprocess
import sys
import tempfile
import uuid

from plash import utils
from plash.core import Container

args = sys.argv[1:]
cmd = []
filtered_args = []
found_first_opt = False
while args:
    arg = args.pop(0)
    if not arg.startswith('-') and not found_first_opt:
        cmd.append(arg)
    elif arg == '--':
        cmd += args
        args = None
    else:
        filtered_args.append(arg)
        found_first_opt = True

if not cmd:
    print("needs at least one command")
    sys.exit(0)


# well, that is copy and paste from the export script
buildscript = utils.get_subcommand_path('build')
p = subprocess.Popen([buildscript] + filtered_args, stdout=subprocess.PIPE)
while True:
    read = p.stdout.readline().decode()
    if not read:
        break
    line = read
    sys.stdout.write(line)
build_exit = p.wait()

if not build_exit:
    container_name = line.split()[-1]
    c = Container(container_name)
    c.run(cmd)
else:
    sys.exit(build_exit)
