#!/bin/sh

# usage: plash with-mount CONTAINER EVAL1 [EVAL2 [EVAL3 ...]]
# Mount the container to a temporary mountpoint, eval, then unmount.
# Example: plash with-mount alpine mv . /tmp/rootfs

set -eu


test "$*" == --help && exec plash-help "$0"
test $# -ge 2 || {
  plash-help --usage "$0"
  exit 2
}

mountpoint=$(mktemp -d)
plash-mount "$1" $mountpoint
cd $mountpoint
shift
set +e
(set -e; eval "$@"); exit=$?
set -e
cd - > /dev/null # cd somewhere else to unmount
umount $mountpoint
exit $exit
