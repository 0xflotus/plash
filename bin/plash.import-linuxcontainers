#!/usr/bin/env python3
import os
import re
import sys
from urllib.request import urlopen

LXC_URL_TEMPL = 'http://images.linuxcontainers.org/images/{}/{}/{}/{}/{}/rootfs.tar.xz'  # FIXME: use https

image_name = sys.argv[1]

content = urlopen('http://images.linuxcontainers.org/').read().decode(
)  # FIXME: use https
matches = re.findall(
    '<tr><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td><td>(.+?)</td></tr>',
    content)

names = {}
for distro, version, arch, variant, date, _, _, _ in matches:
    if not variant == 'default':
        continue

    if arch != 'amd64':  # only support this right now
        continue

    url = LXC_URL_TEMPL.format(distro, version, arch, variant, date)

    if version == 'current':
        names[distro] = url

    elif version[0].isalpha():
        # path parts with older upload_version also come later
        # (ignore possibel alphanumeric sort for dates on this right now)
        names[version] = url
    else:
        names['{}{}'.format(distro, version)] = url

url = names[image_name]
cmd = ['plash.import-url', url, image_name]
os.execvpe(cmd[0], cmd, os.environ)
