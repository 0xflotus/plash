#!/usr/bin/env python3
#
# usage: plash-init
# Initialize build data - run this on a new system before anything else - sory

from plashlib.utils import handle_help_flag
from plashlib import ux
import os
from os.path import join

handle_help_flag()
ux.assert_is_root()

plash_data = os.environ.get('PLASH_DATA', '/var/lib/plash')
os.makedirs(plash_data, exist_ok=True)

# assert only root has access to it
os.chmod(plash_data, 0x700)
os.chown(plash_data, 0, 0)

os.makedirs(join(plash_data, 'index'), exist_ok=True)
os.makedirs(join(plash_data, 'cache_keys'), exist_ok=True)
os.makedirs(join(plash_data, 'tmp'), exist_ok=True)

# create the empty root container
os.makedirs(join(plash_data, 'layers', '0', '_data'), exist_ok=True)
try:
    os.symlink(join(plash_data, 'layers', '0'), join(plash_data, 'index', '0'))
except FileExistsError:
    pass
