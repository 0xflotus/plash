#!/bin/sh
set -eu

test $# -ge 2 || {
  echo 'USAGE: plash with-mount container eval' >&2
  exit 2
}

mountpoint=$(mktemp -d)
plash.mount "$1" $mountpoint
cd $mountpoint
shift
set +e
(set -e; eval "$@"); exit=$?
set -e
cd - > /dev/null # cd somewhere else to unmount
umount $mountpoint
exit $exit
