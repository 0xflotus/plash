#!/usr/bin/env python3
import os
import sys

import plash
from plash.utils import die

SUBSUBCOMMANDS = [
    'data',
    'help',
    'import',
]

def die_helping():
    print(
        'Plash is a lean container build and run engine, try `plash list`',
        file=sys.stderr)
    sys.exit(1)

def subcommand_not_found(subcommand):
    die('no such command: {} (try `plash help`)'.format(subcommand))

try:
    subcommand = sys.argv[1]
except IndexError:
    die_helping()
if subcommand in ('-h', '--help'):
    die_helping()
if '_' in subcommand:
    # the underscore we use for replacing-with-space-magic
    subcommand_not_found(subcommand)

libdir = os.path.dirname(plash.__file__)
libexec = os.path.join(libdir, 'libexec')
os.environ['PATH'] = '{}:{}'.format(libexec, os.environ['PATH'])

if subcommand in SUBSUBCOMMANDS and sys.argv[2:]:
    binfile = 'plash-{}_{}'.format(subcommand, sys.argv[2])
    args = sys.argv[3:]
    not_found_debug = '{} {}'.format(subcommand, sys.argv[2])
else:
    binfile = 'plash-{}'.format(subcommand)
    args = sys.argv[2:]
    not_found_debug = subcommand

binfilepath = os.path.join(libexec, binfile)
try:
    os.execlp(binfilepath, binfile, *args)
except FileNotFoundError:
    subcommand_not_found(not_found_debug)
