#!/usr/bin/env python3
# vim: set filetype=python:
#
# usage: plash-import-tar TARFILE NEW-CONTAINER-ID
# Create a container from a tar file named by the `new-container-id` parameter.

import errno
import os
import shutil
import sys
import tarfile
from os.path import join
from tempfile import mkdtemp
from shutil import rmtree
import atexit
import subprocess

from plashlib.utils import die, info, handle_help_flag, die_with_usage, catch_and_die, hashstr, nodepath_or_die

handle_help_flag()

PLASH_DATA = os.environ.get('PLASH_DATA', '/var/lib/plash')

try:
    tar_file = sys.argv[1]
    image_id = sys.argv[2].replace('/', '%')  # escape for fs
except IndexError:
    die_with_usage()

rootfs = mkdtemp(dir=join(PLASH_DATA, 'tmp'))
atexit.register(lambda: rmtree(rootfs))
if tar_file == '-':
    t = tarfile.open(fileobj=sys.stdin.buffer, mode='r|')
else:
    t = tarfile.open(tar_file)
t.extractall(rootfs)

# we want /etc/resolv to not by a symlink or not to not exist - that makes the later mount not work #FIXME: add a layer for that
resolvconf = join(rootfs, 'etc/resolv.conf')
try:
    os.unlink(resolvconf)
except FileNotFoundError:
    pass
with open(resolvconf, 'w') as f:
    f.seek(0)
    f.truncate()

os.execlp('plash-import-layer', 'plash-import-layer', '/', image_id, rootfs)
